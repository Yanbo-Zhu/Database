
https://juejin.cn/post/7073273393528700964#heading-30
https://juejin.cn/post/7272730422735929396#heading-29


# 1 å¢åˆ æ”¹æŸ¥ 


> é¦–å…ˆå£°æ˜ï¼š**`MongoDB`ä¸­çš„å¤šæ•°æ“ä½œéƒ½å¸¦æœ‰éšå¼åˆ›å»ºç‰¹æ€§**ï¼Œå•¥æ„æ€å‘¢ï¼Ÿå¥½æ¯”ä½ ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºï¼›ä½¿ç”¨ä¸€ä¸ªé›†åˆæ—¶ï¼Œæ²¡æœ‰ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºâ€¦â€¦


## 1.1 Beispiel1

è¿™é‡Œå’±ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œé›†åˆï¼Œå¦‚ä¸‹ï¼š



1 Insert

è¿™é‡Œå’±ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ•°æ®åº“å’Œé›†åˆï¼Œå¦‚ä¸‹ï¼š

```JavaScript
// åˆ‡æ¢åˆ°zhuziåº“ï¼Œæ²¡æœ‰ä¼šè‡ªåŠ¨åˆ›å»º
use zhuzi;
// å‘xiong_maoé›†åˆæ’å…¥ä¸€æ¡æ•°æ®ï¼ˆæ²¡æœ‰é›†åˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
db.xiong_mao.insert({_id:1});
```

å’Œ`Python`ä¸€æ ·ï¼Œæœ€åçš„åˆ†å·å¯å†™å¯ä¸å†™ï¼Œä¸è¿‡å»ºè®®å†™ä¸Šï¼Œä»¥æ­¤å¢åŠ ä»£ç çš„å¯è¯»æ€§ã€‚

ç°åœ¨ç»§ç»­å¾€`xiong_mao`é›†åˆä¸­æ’å…¥ä¸¤æ¡æ•°æ®ï¼š

```JavaScript
db.xiong_mao.insert({_id:2, name:"è‚¥è‚¥", age:3, hobby:"ç«¹å­"});
db.xiong_mao.insert({name:"èŠ±èŠ±", color:"é»‘ç™½è‰²"});
```

---

2  æŸ¥è¯¢ 

```js
// æŸ¥è¯¢xiong_maoé›†åˆçš„æ‰€æœ‰æ•°æ®
db.xiong_mao.find();

// ------- è¿”å›ç»“æœ ----------
[
  { _id: 1 },
  { _id: 2, name: 'è‚¥è‚¥', age: 3, hobby: 'ç«¹å­' },
  {
    _id: ObjectId("64d0b843fa3b00006f0044d6"),
    name: 'èŠ±èŠ±',
    color: 'é»‘ç™½è‰²'
  }
]

```



æ³¨æ„è§‚å¯Ÿç¬¬ä¸‰æ¡æ•°æ®ï¼Œåœ¨æ’å…¥æ—¶æˆ‘ä»¬å¹¶æœªæŒ‡å®š`_id`å€¼ï¼Œå¯ä¸ºå•¥è¿˜æ˜¯æœ‰è¿™ä¸ªå­—æ®µå‘¢ï¼Ÿå› ä¸º`_id`æ˜¯`mongoDB`çš„é»˜è®¤å­—æ®µï¼Œæ¯ä¸ªæ–‡æ¡£ï¼ˆæ¯è¡Œæ•°æ®ï¼‰å¿…é¡»è¦æœ‰è¯¥å­—æ®µï¼Œå¦‚æœæ’å…¥æ—¶æœªæŒ‡å®šè¯¥å­—æ®µï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç±»ä¼¼äºé›ªèŠ±`ID`çš„`ObjectId`å€¼ï¼Œ`mongoDB`ä¼šä½¿ç”¨`_id`æ¥ç»´æŠ¤æ•°æ®çš„å­˜å‚¨ç»“æ„ï¼ˆç±»ä¼¼äº[`InnoDBçš„éšè—åˆ—-row_id`](https://juejin.cn/post/7155359629050904584#heading-11 "https://juejin.cn/post/7155359629050904584#heading-11")ï¼Œåé¢å†ç»†èŠï¼‰ã€‚


å¦‚ä½•æ ¹æ®æŒ‡å®šæ¡ä»¶æŸ¥è¯¢æ•°æ®å‘¢ï¼Ÿå¦‚ä¸‹ï¼š

```JavaScript
// æŸ¥è¯¢_id=2çš„æ•°æ®
db.xiong_mao.find({_id:2});
// æŸ¥è¯¢name=èŠ±èŠ±çš„æ•°æ®
db.xiong_mao.find({name:"èŠ±èŠ±"});
```

å¤§å®¶ä¼šå‘ç°ï¼Œå‰é¢æˆ‘ä»¬ä»¥`Json`å½¢å¼å°†æ•°æ®æ’å…¥åˆ°é›†åˆåï¼Œåœ¨æŸ¥è¯¢æ—¶ï¼Œå’±ä»¬å¯ä»¥ç›´æ¥é€šè¿‡`Json`ä¸­çš„å­—æ®µåæ¥æ“ä½œï¼Œè¿™ä¹Ÿå°±å°è¯äº†æœ€å¼€å§‹æ‰€è¯´çš„â€œåŠç»“æ„åŒ–â€ç‰¹å¾ï¼Œå› ä¸ºåƒ`Redisã€Memcached`è¿™ç±»`NoSQL`ï¼Œè™½ç„¶ä¹Ÿèƒ½æŠŠæ•°æ®`Json`åºåˆ—åŒ–åå­˜è¿›å»ï¼Œä½†æƒ³è¦æ“ä½œæ—¶ï¼Œåªèƒ½å…ˆè¯»å‡ºæ¥å†ååºåˆ—åŒ–æˆå¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥å¯¹åºåˆ—åŒ–åçš„`Json`å­—ç¬¦ä¸²è¿›è¡Œæ“ä½œï¼

---


3  ä¿®æ”¹ åˆ é™¤ 

æœ€åå†æ¥å­¦ä¹ ä¸€ä¸‹ä¿®æ”¹ã€åˆ é™¤æ“ä½œï¼š

```JavaScript
// å°†_id=2çš„æ•°æ®ï¼Œçˆ±å¥½ä¿®æ”¹ä¸ºï¼šåƒç«¹å­ã€ç¡è§‰
db.xiong_mao.update({_id:2},{hobby:"åƒç«¹å­ã€ç¡è§‰"});
// ä¸Šé¢é‚£ç§æ–¹å¼ï¼Œä¼šå¯¼è‡´å…¶ä»–å­—æ®µå˜nullï¼Œè¦è®°å¾—åŠ {$set:}ï¼Œè¡¨ç¤ºå±€éƒ¨ä¿®æ”¹
db.xiong_mao.update({_id:2},{$set:{hobby:"åƒç«¹å­ã€ç¡è§‰"}});

// åˆ é™¤_id=1çš„æ•°æ®
db.xiong_mao.remove({_id:1});
```

OKï¼Œæˆ‘ä»¬è¿‡äº†ä¸€ä¸‹æœ€ç®€å•çš„`CRUD`æ“ä½œï¼Œè¿™é‡Œä¸»è¦æ˜¯è®©å¤§å®¶å…ˆç†Ÿæ‚‰ä¸‹è¯­æ³•ï¼Œè¯¸ä½ä¹Ÿå¯ä»¥è‡ªè¡Œå¤šç»ƒä¹ ä¸€ä¸‹ã€‚

ç›¸è¾ƒäº`SQL`çš„è¯­æ³•æ¥è¯´ï¼Œ`MongoDB`çš„è¯­æ³•æ˜¾å¾—æœ‰ç‚¹åäººç±»ï¼›åè§‚åŒä¸º`NoSQL`çš„`Redis`ï¼Œå®ƒçš„å‘½ä»¤åˆ™æ˜¾å¾—ç®€æ´æ¸…çˆ½è®¸å¤šã€‚å½“ç„¶ï¼Œç†Ÿæ‚‰`JS`çš„å°ä¼™ä¼´ï¼Œæ¥è§¦è¿™ä¸ªè¯­æ³•ä¸ç®—å¤ªéš¾ï¼Œæ¯•ç«Ÿè¿™å°±æ˜¯`JS`çš„è¯­æ³•ï¼Œå¦‚æœåªæ˜¯çº¯åç«¯çš„å¼€å‘è€…ï¼Œæƒ³é€‚åº”è¿‡æ¥éœ€è¦ä¸€å®šçš„ç»ƒä¹ ã€‚






## 1.2 Beispiel 2 

fÃ¼r Schreiboperationen
![](images/Pasted%20image%2020250206221421.png)


Beispiel fÃ¼r Leseoperationen
// åœ¨æŸä¸ª collection æŸ¥æ‰¾æŸä¸ª ducument 
db.users.find()  
db.message.find() 

![](images/Pasted%20image%2020250206221436.png)

![](images/Pasted%20image%2020250206221443.png)



# 2 EinfÃ¼gen:  `insert`

```js
db.posts.insert({
  "title": "Second Post",
  "user": "Alice"
})


db.posts.update({
  "user": "Alice"
}, {
  "title": "Second Post", 
  "user": "Alice"});
}, {
  upsert: true
})


db.posts.save({
// å¦‚æœä¸å†™ "_id": Object("45c230a123d45efab2340"),, è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª id 
  "title": "Second Post",
  "user": "Alice"
})


db.posts.save({
  "_id": Object("45c230a123d45efab2340"),
  "title": "Second Post",
  "user": "Alice"
})

```

- `**insert(document)**`: hÃ¤ufigste Methode zum EinfÃ¼gen neuer Dokumente in eine Kollektion
- `**document**`Â als einziges Argument der Methode
- `**_id**`Â wird automatisch generiert und dem Dokument zugewiesen
- Verursacht ggfs. das Anlegen einer neuen Kollektion, wenn die angegebene nicht existiert
- `**update(selectionCriteria, updateStatement, options)**`: alternative Methode zum EinfÃ¼gen von Dokumenten
- `**upsert**`Â ist `**true**`Â wenn ein neues Dokument angelegt werden soll wenn kein Dokument mit den Suchkriterien in der Kollektion vorhanden ist
- `**save(document)**`: weitere Alternative, die optional die Definition einer eigenen `**_id**`Â erlaubt

## 2.1 insert 


`MongoDB`ä¸­æä¾›äº†ä¸‰ä¸ªæ˜¾å¼å‘é›†åˆæ’å…¥æ•°æ®çš„æ–¹æ³•ï¼š

```JavaScript
// å‘é›†åˆæ’å…¥å•æ¡æˆ–å¤šæ¡æ•°æ®ï¼ˆéœ€è¦ç”¨[]æ¥åŒ…è£¹å¤šä¸ªæ–‡æ¡£ï¼‰
db.xiong_mao.insert([
    {_id:4, name:"é»‘ç†Š", age:3, food:{name:"é»„é‡‘ç«¹", grade:"S"}},
    {_id:5, name:"ç™½ç†Š", age:4, food:{name:"ç¿ ç»¿ç«¹", grade:"B"}}
]);

// å‘é›†åˆæ’å…¥å•æ¡æ•°æ®
db.xiong_mao.insertOne({_id:6, name:"æ£•ç†Š"});

// å‘é›†åˆæ‰¹é‡æ’å…¥å¤šæ¡æ•°æ®
db.xiong_mao.insertMany([
    {_id:7, name:"çº¢ç†Š", age:2, food:{name:"ç™½ç‰ç«¹", grade:"S"}},
    {_id:8, name:"ç²‰ç†Š", age:6, food:{name:"ç¿¡ç¿ ç«¹", grade:"A"}}
]);
```


ä»æ¡ˆä¾‹ä¸­å¯å‘ç°ï¼Œæ¯ä¸ªå­—æ®µå¯ä»¥æ— é™åµŒå¥—`json`ã€‚åŒæ—¶ï¼Œè¿™ä¸‰ä¸ª`insert`æ–¹æ³•éƒ½æœ‰ä¸¤ä¸ªå¯é€‰é¡¹ï¼Œå¦‚ä¸‹ï¼š

```JavaScript
db.collection.insertXXX(
   [ <document 1> , <document 2>, ... ],
   {
      writeConcern: <document>,
      ordered: <boolean>
   }
)
```

`writeConcern`è¡¨ç¤ºåµŒå¥—æ–‡æ¡£ï¼Œè¿™ä¸ªå’±ä»¬åç»­å†ç»†è¯´ï¼›`ordered`è¡¨ç¤ºæœ¬æ¬¡æ˜¯å¦æŒ‰é¡ºåºæ’å…¥ï¼Œ`2.6`ä»¥ä¸Šç‰ˆæœ¬é»˜è®¤ä¸º`true`ï¼Œè¡¨ç¤ºæŒ‰æŒ‡å®šçš„é¡ºåºæ’å…¥æ•°æ®ã€‚


## 2.2 `bulkWrite()`

é™¤å¼€ä¸Šé¢ä¸‰ä¸ªå¸¸ç”¨çš„æ’å…¥æ–¹æ³•å¤–ï¼Œ`MongoDB`è¿˜å¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼å®ç°æ•°æ®æ–°å¢ï¼Œå¦‚ï¼š

```JavaScript
const bulkOps = [
  {insertOne: {document: {_id: 9, name: "é»„ç†Š"}}},
  {insertOne: {document: {_id: 10, name: "ç°ç†Š"}}}
];
db.xiong_mao.bulkWrite(bulkOps);
```

`bulkWrite()`æ–¹æ³•å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ“ä½œæ•°ç»„ï¼Œ`MongoDB`ä¼šæŒ‰ç…§ç»™å®šçš„æ“ä½œé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå…¶ä¸­è¿˜å¯ä»¥æ”¾ä¿®æ”¹ã€åˆ é™¤ç­‰`MongoDB`æ”¯æŒçš„æ“ä½œã€‚æœ€åï¼Œè¿˜èƒ½é€šè¿‡ä¿®æ”¹å‘½ä»¤ï¼Œå‘é›†åˆä¸­éšå¼æ’å…¥æ•°æ®ï¼Œåœ¨ä½¿ç”¨ä¿®æ”¹å‘½ä»¤æ—¶ï¼Œå°†`upsert`è®¾ä¸º`true`å³å¯ï¼ˆåé¢ä¼šæ¼”ç¤ºï¼‰ã€‚



# 3 LÃ¶schen: 

## 3.1 `remove`

```js

// æ ¹æ®æŒ‡å®šæ¡ä»¶åˆ é™¤é›†åˆä¸­çš„æ•°æ®
db.xiong_mao.remove({_id:1});

// åˆ é™¤é›†åˆä¸­çš„æ‰€æœ‰æ•°æ®ï¼ˆä¸å†™æ¡ä»¶å³å¯ï¼‰
db.xiong_mao.remove({});

db.collectionName.remove(
	<query>, // æ¡ä»¶ï¼›
	{				
    	// æ˜¯å¦ä»…åˆ é™¤ä¸€æ¡æ•°æ®ï¼› å¦‚æœ justOne ä¸é€‰æ‹©æˆ–è€…å‚æ•°ä¸º false åˆ™è¡¨ç¤ºåˆ é™¤åŒ¹é…åˆ°çš„æ‰€æœ‰æ–‡æ¡£ï¼›
    	// > **å¦‚æœremoveä¸å¸¦æœ‰æ¡ä»¶çš„è¯ï¼ˆä½†ä»è¦åœ¨æ¡ä»¶å¤„å¸¦æœ‰ `{}`è¡¨ç¤ºç©ºæ¡ä»¶ï¼‰ï¼Œå°±æ˜¯åˆ é™¤æ‰€æœ‰**;	
		justOne: <boolean>, 
        
        // å¦‚æœæŠ›å‡ºæ„å¤–ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸çº§åˆ«ï¼›
        writeConcern: <Document> 
	}
);

db.posts.remove()
//Entfernt alle Dokumente der Kollektion


db.posts.remove({"user": "Alice"})
//Entfernt alle Dokumente mit user=Alice

db.posts.remove({"user": "Alice"}, true)
```


- `**remove(selectionCriteria, justOne)**`: Methode zum LÃ¶schen von Kollektionen oder einer oder mehrerer Dokumente
- `**selectionCriteria**`: s.o.
- `**justOne**`: zeigt an, dass bei mehreren Dokumenten, die `**selectionCriteria**`Â erfÃ¼llen, nur eines gelÃ¶scht wird


`MongoDB`ä¸­çš„åˆ é™¤å‘½ä»¤ï¼Œæœ‰`removeã€delete`ä¸¤ç±»æ–¹æ³•ï¼š




## 3.2 delete

```js



// æ ¹æ®æ¡ä»¶åˆ é™¤å•æ¡æ•°æ®ï¼ˆæœ‰å¤šæ¡æ•°æ®æ»¡è¶³æ¡ä»¶æ—¶ï¼Œåªä¼šåˆ ç¬¬ä¸€æ¡ï¼‰
db.xiong_mao.deleteOne({_id:6, name:"æ£•ç†Š"});

// æ ¹æ®æ¡ä»¶åˆ é™¤å¤šæ¡æ•°æ®ï¼ˆæ»¡è¶³æ¡ä»¶çš„å…¨éƒ¨åˆ é™¤ï¼‰
db.xiong_mao.deleteMany({name:"çº¢ç†Š"});


// æ ¹æ®æ¡ä»¶åˆ é™¤æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œå¹¶è¿”å›åˆ é™¤åçš„æ•°æ®
db.xiong_mao.findOneAndDelete({_id:2});
```


å½“ç„¶ï¼Œè¿™é‡Œåªåˆ—å‡ºäº†æ ¹æ®ç­‰å€¼æ¡ä»¶åˆ é™¤çš„æ“ä½œï¼Œç±»ä¼¼äº`SQL`ä¸­çš„`<ã€>ã€inã€orã€andâ€¦â€¦`æ€ä¹ˆå†™å‘¢ï¼Ÿè¿™äº›æ”¾åˆ°åç»­çš„æŸ¥è¯¢æ“ä½œä¸­è®²è§£ï¼Œå› ä¸ºæ¡ä»¶è¿‡æ»¤å™¨åœ¨`MongoDB`ä¸­æ˜¯é€šç”¨çš„ã€‚

# 4 Aktualisieren 


## 4.1 update

```js
db.posts.update({
  "user": "Alice"
}, {
  $set: {
    "title": "Second Post", 
}}, {
  multi: true
})

//Entfernt ein Dokument mit user=Alice


db.collectionName.update(
	<query>,
	<update>,
	{
		upsert: <boolean>,
		mulit: <boolean>,
		wirteConcern: <Document>
	}
);

--- è¿™ä¸ªæ›´æ–°æ˜¯å°†ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨æ›´æ–°æˆåé¢çš„æ–‡æ¡£ï¼Œç›¸å½“äºå…ˆåˆ é™¤å†æ›´æ–°ï¼›
> db.collectionName.update({"name": "UrbaneH"}, {"name": "11", "bir": new date()})


--- ä¿ç•™åŸæ¥çš„æ•°æ®æ›´æ–°ï¼Œä½†åªæ›´æ–°ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€æ¡æ•°æ®ï¼›
> db.collectionName.update({"name": "UrbaneH"}, {$set: {"name": "xiaohua"}})

--- ä¿ç•™åŸæ¥çš„æ•°æ®æ›´æ–°ï¼Œæ›´æ–°ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼›
> db.collectionName.update({"name": "UrbaneH"}, {$ser: {"name": "xiaohua"}}, {mulit: true})


--- ä¿ç•™åŸæ¥çš„æ•°æ®æ›´æ–°ï¼Œæ›´æ–°ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰æ•°æ®ï¼Œæ²¡æœ‰ç¬¦åˆæ¡ä»¶æ—¶æ’å…¥æ•°æ®ï¼›
> db.collectionName.update(
	{"name": "UrbaneH"},
	{$set: {"name": "xiaohua"}},
	{
		mulit: true,
		upset: true
	}
)


```

- `**update(selectionCriteria, updateStatement, options)**`: Methode zum Aktualisieren von Dokumenten einer Kollektion (oder zum EinfÃ¼gen eines neuen Dokuments falls `**selectionCriteria**`Â durch kein existierendes Dokument erfÃ¼llt werden)
- `**selectionCriteria**`: enthÃ¤lt einfache oder zusammengesetzte Anfrageselektoren
- `**updateStatement**`: spezifiziert die zu aktualisierenden Felder
- `**options**`: verschiedene Optionen, zum Beispiel ob ein oder mehrere Dokumente aktualisiert werden sollen

> **query**ï¼šupdateçš„æŸ¥è¯¢æ¡ä»¶ï¼Œç±»ä¼¼sql updateæŸ¥è¯¢whereåé¢çš„éƒ¨åˆ†ï¼›

> **update**ï¼šupdateçš„å¯¹è±¡å’Œä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦ï¼ˆå¦‚$, $inc, ......ï¼‰ç­‰ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºsql updateæŸ¥è¯¢å†…çš„setåé¢çš„éƒ¨åˆ†ï¼›

> **upsert**ï¼š`å¯é€‰`ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨updateçš„è®°å½•ï¼Œæ˜¯å¦æ’å…¥objNewï¼Œé»˜è®¤ä¸º `false` ä¸æ’å…¥ï¼›`<boolaen>ç±»å‹`

> **mulit**ï¼š`å¯é€‰`ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œæ˜¯å¦åªæ›´æ–°æ‰¾åˆ°çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œé»˜è®¤ä¸º `false` ï¼Œå¦‚æœä¸º **true** åˆ™å°†æ‰€æœ‰æŸ¥è¯¢åˆ°çš„æ•°æ®éƒ½è¿›è¡Œæ›´æ–°ï¼›`<boolean>ç±»å‹`

> **wirteConcern**ï¼š`å¯é€‰`ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸çº§åˆ«

  


```JavaScript
// æ ¹æ®æ¡ä»¶ä¿®æ”¹é›†åˆä¸­çš„å•æ¡æ•°æ®ï¼ˆå¤šæ¡æ•°æ®æ»¡è¶³æ¡ä»¶æ—¶ï¼Œåªä¿®æ”¹ç¬¬ä¸€æ¡ï¼‰
db.xiong_mao.updateOne({_id:7}, {$set:{name:"è‹±ç†Š"}});

// æ ¹æ®æ¡ä»¶ä¿®æ”¹é›†åˆä¸­çš„å¤šæ¡æ•°æ®ï¼ˆcolorå­—æ®µä¸å­˜åœ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¹¶èµ‹å€¼ï¼‰
db.xiong_mao.updateMany({age:3}, {$set:{color:"é»‘ç™½è‰²"}});


// æ ¹æ®æ¡ä»¶ä¿®æ”¹é›†åˆä¸­çš„å•æ¡æ•°æ®ï¼ˆå¯ä»¥é€šè¿‡.åˆ†å‰²çš„å½¢å¼ï¼Œä¿®æ”¹åµŒå¥—çš„jsonï¼‰
db.xiong_mao.update({_id:8}, {$set:{age:3, "food.grade":"C"}});

// æ ¹æ®æ¡ä»¶ä¿®æ”¹é›†åˆä¸­çš„å•/å¤šæ¡æ•°æ®ï¼ˆå¦‚æœæƒ³é€šè¿‡updateæ›´æ–°å¤šæ¡ï¼Œéœ€è¦ä½¿ç”¨multiï¼‰
db.xiong_mao.update({age:3}, {$set:{hobby:"ç«¹å­"}},{multi:true});
```

ä¿®æ”¹æ“ä½œé»˜è®¤æ˜¯å…¨é‡ä¿®æ”¹ï¼Œå³ä½¿ç”¨æŒ‡å®šçš„å€¼ï¼Œè¦†ç›–åŸæœ‰çš„æ•´æ¡æ•°æ®ï¼Œå¦‚æœæœ‰äº›å­—æ®µå€¼åœ¨ä¿®æ”¹æ—¶æœªç»™å®šï¼Œåˆ™ä¼šå˜ä¸º`null`ï¼ˆæ¶ˆå¤±ï¼‰ã€‚ä¸ºæ­¤ï¼Œå¦‚è‹¥åªæƒ³ä¿®æ”¹æŸå‡ ä¸ªå­—æ®µï¼Œè®°å¾—åœ¨å‰é¢åŠ ä¸Š`$set`é€‰é¡¹ã€‚

å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿä»…æ˜¯ç”¨`_id`åœ¨åšç­‰å€¼æ¡ä»¶ä¿®æ”¹ï¼Œåé¢è®²å®ŒæŸ¥è¯¢æ“ä½œåï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå¥—å…¥å„ç§å¤æ‚æ¡ä»¶è¿›è¡Œä¿®æ”¹ã€‚

---


è¿˜è®°å¾—æè¿‡çš„â€œä¿®æ”¹æ—¶éšå¼æ–°å¢â€å˜›ï¼Ÿæ¼”ç¤ºä¸€ä¸‹ï¼š

```JavaScript
db.xiong_mao.update(
	{_id:11}, 
	{name:"ç´«ç†Š", age:3, food:{name:"æ˜æœˆç«¹", grade:"A"}}, 
	{upsert:true}
);
```

åœ¨ä¿®æ”¹æ—¶ï¼Œåªéœ€æŒ‡å®š`upsert:true`å³å¯ï¼Œè¿™æ ·åœ¨æœªåŒ¹é…åˆ°å¯¹åº”æ¡ä»¶çš„æ•°æ®æ—¶ï¼Œä¼šå°†æœ¬æ¬¡ä¿®æ”¹çš„æ•°æ®æ’å…¥åˆ°é›†åˆä¸­ï¼Œè€Œå‰é¢æ¼”ç¤ºçš„æ‰€æœ‰ä¿®æ”¹æ–¹æ³•ï¼Œéƒ½æ”¯æŒæŒ‡å®š`upsert`é€‰é¡¹ã€‚


## 4.2 `findAndModify()ã€findOneAndUpdate()ã€findOneAndReplace()`

ä¿®æ”¹æ“ä½œé™¤å¼€ä¸Šè¿°æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡`findAndModify()ã€findOneAndUpdate()ã€findOneAndReplace()`æ–¹æ³•æ¥ä¿®æ”¹ï¼Œå¦‚ï¼š

```JavaScript
db.xiong_mao.findAndModify({
  query:{_id:8},
  update:{$set:{color: "ç´«è‰²"}},
  new: true
});
```

è¿™äº›`findAnd`å¼€å¤´çš„ä¿®æ”¹æ–¹æ³•ï¼Œä¼šæ ¹æ®æ¡ä»¶ä¿®æ”¹æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€æ¡æ•°æ®ï¼Œä¿®æ”¹å®Œä¹‹åï¼Œå¦‚æœ`new`æŒ‡å®šä¸º`true`ï¼Œåˆ™ä¼šè¿”å›ä¿®æ”¹åçš„æ•°æ®ï¼Œå¦‚æœä¸º`false`ï¼Œåˆ™è¿”å›ä¿®æ”¹å‰çš„æ•°æ®ï¼ˆå…¶ä½™ä¸¤ä¸ªæ–¹æ³•ç±»ä¼¼ï¼Œä¸å†ç»§ç»­æ¼”ç¤ºï¼‰ã€‚


## 4.3 replace


// æ ¹æ®æ¡ä»¶æ›¿æ¢æ‰å•è¡Œæ•°æ®ï¼ˆä½¿ç”¨æ–°æ•°æ®æ›¿æ¢è€çš„æ•°æ®ï¼‰
```
db.xiong_mao.replaceOne({_id:6}, {name:"æ£•ç†Š", age:3, color:"æ£•è‰²"});
```


# 5 Lesen (READ) 

- `**find(selectionCriteria)**`: Methode zum Finden und Lesen von Dokumenten einer Kollektion
- `**selectionCriteria**`Â enthÃ¤lt einfache oder zusammengesetzte Anfrageselektoren
- Beachte: alle MongoDB-Operatoren werden mit einem `**$**`Â eingeleitet

`db.collectionName.find(query, projection);`
-  **query**ï¼š`å¯é€‰` ä½¿ç”¨æŸ¥è¯¢æ“ä½œç¬¦æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼›
- **projection**ï¼š`å¯é€‰` ä½¿ç”¨æŠ•å½±æ“ä½œç¬¦æŒ‡å®šè¿”å›çš„é”®ã€‚æŸ¥è¯¢æ—¶è¿”å›æ–‡æ¡£ä¸­æ‰€æœ‰çš„é”®å€¼ï¼Œåªéœ€è¦çœç•¥è¯¥å‚æ•°å³å¯ã€‚é»˜è®¤ä¸ºçœç•¥ï¼›

`db.collectionName.find(query, projection).pretty();`
é»˜è®¤çš„æŸ¥è¯¢æ˜¯éç»“æ„åŒ–çš„ï¼Œå¦‚æœéœ€è¦ä½¿å¾—ç»“æœç»“æ„åŒ–ä¹Ÿæ›´åŠ æ˜“è¯»ï¼Œéœ€è¦åœ¨åé¢åŠ ä¸Š pretty()
  

```js
db.posts.find() //alle Dokumente einer Kollektion

db.posts.find({}) //alle Dokumente einer Kollektion

db.posts.find({ "user": "Alice"})

db.posts.find(
  {"user": {$in: ["Alice", "Bob"]}}
) //alle Dokumente mit user=Alice oder Bob

db.posts.find({
  $or: [{"user": "Alice"}, {"user": "Bob"}]}
) // //alle Dokumente mit user=Alice oder Bob

db.posts.find({
  "user": "Alice",
  "commentsCount": {$gt: 10}
}) //alle Dokumente mit user=Alice und commentsCount>10

```


## 5.1 åŸºæœ¬æŸ¥è¯¢è¯­å¥

```JavaScript
// æŸ¥è¯¢é›†åˆæ‰€æœ‰æ•°æ®
db.xiong_mao.find();

// æ ¹æ®å•ä¸ªç­‰å€¼æ¡ä»¶æŸ¥è¯¢æ•°æ®
db.xiong_mao.find({_id:2});

// æŸ¥è¯¢æ»¡è¶³å¤šä¸ªç­‰å€¼æ¡ä»¶çš„æ•°æ®ï¼ˆandæŸ¥è¯¢ï¼‰
db.xiong_mao.find({age:3, "food.grade":"S"});

// æŸ¥è¯¢æ»¡è¶³ä»»æ„ä¸€ä¸ªæ¡ä»¶çš„æ•°æ®ï¼ˆoræŸ¥è¯¢ï¼‰
db.xiong_mao.find({$or: [{age:2}, {"food.grade":"S"}]});

// æŸ¥è¯¢å•å­—æ®µæ»¡è¶³ä»»æ„ä¸€ä¸ªæ¡ä»¶çš„æ•°æ®ï¼ˆinæŸ¥è¯¢ï¼‰
db.xiong_mao.find({age:{$in: [2, 4]}});

// æŸ¥è¯¢é¢œè‰²ä¸ºé»‘ç™½è‰²ï¼Œå¹¶ä¸”å¹´é¾„å°äº5å²çš„æ•°æ®
db.xiong_mao.find({color:"é»‘ç™½è‰²", age:{$lt: 5}});

// æŸ¥è¯¢çˆ±å¥½ä¸ºç«¹å­ï¼Œæˆ–idå¤§äº9çš„æ•°æ®
db.xiong_mao.find({$or: [{hobby:"ç«¹å­"}, {_id: {$gt:9}}]});

// æŸ¥è¯¢idå°äºç­‰äº5ï¼Œå¹¶ä¸”ï¼ˆageå¤§äºç­‰äº2 æˆ– nameä¸ºè‚¥è‚¥ï¼‰çš„æ•°æ®
db.xiong_mao.find({
	_id:{$lte:5}, 
	$or: [{age: {$gte:2}}, {name:"è‚¥è‚¥"}]
});

// æŸ¥è¯¢nameä¸ä¸ºâ€œç™½ç†Šâ€ æˆ– age ä¸å¤§äº 2 çš„æ•°æ®
db.xiong_mao.find({$nor: [{name:"ç™½ç†Š"}, {age:{$gt:2}}]});

// æŸ¥è¯¢idåœ¨3~5ä¹‹é—´çš„æ•°æ®ï¼ˆbetween andèŒƒå›´æŸ¥è¯¢ï¼‰
db.xiong_mao.find({$and: [{_id:{$gte:3}}, {_id:{$lte:5}}]});

// æŸ¥è¯¢nameä»¥â€œç²‰â€å¼€å¤´çš„æ•°æ®ï¼ˆlikeå³æ¨¡ç³ŠæŸ¥è¯¢ï¼‰
db.xiong_mao.find({name:/^ç²‰/});
```

ä¸Šè¿°ä¸€äº›æŸ¥è¯¢è¯­å¥ï¼Œå¯¹åº”ç€`SQL`ä¸­çš„åŸºæœ¬æŸ¥è¯¢ï¼Œå¦‚`=ã€<ã€>ã€<=ã€>=ã€inã€likeã€andã€or`ï¼Œå¤§å®¶ä»”ç»†è§‚å¯Ÿä¼šå‘ç°ï¼Œå…¶ä¸­æœ‰è®¸å¤š`$`å¼€å¤´çš„ä¸œä¸œï¼Œè¿™ä¸ªæ˜¯å•¥ï¼Ÿåœ¨`MongoDB`ä¸­ç§°ä¹‹ä¸ºæ“ä½œç¬¦ï¼Œæ“ä½œç¬¦æœ‰è®¸å¤šï¼Œåˆ†åˆ«å¯¹åº”ç€`SQL`ä¸­çš„å…³é”®å­—ä¸ç‰¹æ®Šå­—ç¬¦ï¼Œä¸‹é¢åˆ—å†™å¸¸ç”¨çš„ï¼š

|SQL|MongoDB|
|:-:|:-:|
|`=`|`:`|
|`=ã€<ã€>ã€<=ã€>=ã€!=`|`$eqã€$ltã€$gtã€$lteã€$gteã€$ne`|
|`inã€not in`|`$inã€$nin`|
|`andã€orã€notã€is null`|`$andã€$orã€$notã€$exists`|
|`+ã€-ã€*ã€/ã€%`|`$addã€$subtractã€$multiplyã€$divideã€$mod`|
|`group byã€order by`|`$groupã€$sort`|
|`â€¦â€¦`|`â€¦â€¦`|

ä¸Šè¡¨ä»…ä»…åªåˆ—å‡ºäº†ä¸€äº›åœ¨`SQL`ä¸­æ¯”è¾ƒå¸¸è§çš„ï¼Œå®åˆ™`MongoDB`æä¾›äº†å‡ ç™¾ä¸ªæ“ä½œç¬¦ï¼Œä»¥æ­¤æ¥æ»¡è¶³å„ç±»åœºæ™¯ä¸‹çš„éœ€æ±‚ï¼Œå¦‚æœä½ æƒ³è¦è¯¦ç»†äº†è§£ï¼Œå¯ä»¥å‚è€ƒ[MongoDBå®˜ç½‘-Operators](https://link.juejin.cn?target=https%3A%2F%2Fwww.mongodb.com%2Fdocs%2Fv6.0%2Freference%2Foperator%2F "https://www.mongodb.com/docs/v6.0/reference/operator/")ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ è‹±è¯­é˜…è¯»èƒ½åŠ›æ¬ ä½³ï¼Œå¯ä»¥å‚è€ƒ[MongoDBä¸­æ–‡ç½‘-è¿ç®—ç¬¦](https://link.juejin.cn?target=https%3A%2F%2Fdocs.mongoing.com%2Fcan-kao%2Fyun-suan-fu "https://docs.mongoing.com/can-kao/yun-suan-fu")ã€‚


---

æ¥ç€æ¥çœ‹çœ‹å…¶ä»–æŸ¥è¯¢çš„è¯­æ³•ï¼š

```JavaScript
// å¯¹æŒ‡å®šå­—æ®µå»é‡ï¼Œå¹¶è¿”å›å»é‡åçš„å­—æ®µå€¼åˆ—è¡¨
db.xiong_mao.distinct("age");

// æ ¹æ®æ¡ä»¶ç»Ÿè®¡é›†åˆå†…çš„æ•°æ®è¡Œæ•°
db.xiong_mao.count({age:3});

// æ ¹æ®æ¡ä»¶è¿›è¡Œåˆ†é¡µæŸ¥è¯¢ï¼ˆlimitå†™è¡Œæ•°ï¼Œskipå†™è·³è¿‡å‰é¢å¤šå°‘æ¡ï¼‰
db.xiong_mao.find({_id:{$lt:6}}).skip(0).limit(2); // ç¬¬ä¸€é¡µ
db.xiong_mao.find({_id:{$lt:6}}).skip(2).limit(2); // ç¬¬äºŒé¡µ

// æ ¹æ®æŒ‡å®šå­—æ®µè¿›è¡Œæ’åºæŸ¥è¯¢ï¼ˆorder byæŸ¥è¯¢ï¼‰
// æ ¹æ®å¹´é¾„å‡åºï¼Œå¹´é¾„ç›¸åŒæ ¹æ®idé™åºï¼ˆ1ï¼šå‡åºï¼Œ-1ï¼šé™åºï¼‰
db.xiong_mao.find().sort({age:1, _id:-1});

// æŠ•å½±æŸ¥è¯¢ï¼šåªè¿”å›æŒ‡å®šçš„å­—æ®µï¼ˆ0è¡¨ç¤ºä¸è¿”å›ï¼Œ1ä»£è¡¨è¿”å›ï¼‰
db.xiong_mao.find({color:"é»‘ç™½è‰²"}, {_id:0, name:1, color:1});
```

è¿™é‡Œåˆåˆ—å‡ºäº†ä¸€äº›`SQL`ä¸­ç»å¸¸æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚ç»Ÿè®¡ã€å»é‡ã€æ’åºã€åˆ†é¡µã€æŠ•å½±æŸ¥è¯¢ç­‰ï¼Œå’Œ`SQL`ä¸€æ ·ï¼Œä¸åŒç±»å‹çš„å‡½æ•°ï¼Œæ‰§è¡Œçš„ä¼˜å…ˆçº§ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼š

```JavaScript
db.xiong_mao.find({_id:{$lt:6}}).limit(2).skip(2).sort({_id:-1}).count();
```

è¿™æ¡æŸ¥è¯¢è¯­å¥ä¸­ï¼ŒåŒ…å«äº†`limilt()ã€skip()ã€sort()ã€count()`å››ä¸ªæ–¹æ³•ï¼Œå¯å®é™…çš„æ‰§è¡Œé¡ºåºï¼Œè·Ÿä¹¦å†™çš„é¡ºåºæ— å…³ï¼Œè¿™äº›æ–¹æ³•åŒæ—¶å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œçš„ä¼˜å…ˆçº§ä¸ºï¼š`sort() > skip() > limilt() > count()`ã€‚

---

1
ANDæŸ¥è¯¢
db.collectionName.find({key1:value1, key2: value2});`
**å¦‚æœç›¸åŒçš„å­—æ®µå‡ºç°çš„è¯ä¼šä»¥æœ€åä¸€æ¬¡å‡ºç°ä¸ºå‡†ï¼›**
**ç±»ä¼¼äº where çš„ WHERE key1 = value1 AND key2 = value2ï¼›**

2
ORæŸ¥è¯¢
ç±»ä¼¼äº WHERE key1 = value1 OR key2 = value2;
```
db.collectionName.find({
	$or: [
		{key1: value1}, {key2: value2}
	]
}).pretty()

```

3
ANDå’ŒORæŸ¥è¯¢
> `db.collectionName.find({"age": {$gt: 50}}, $or: [{"name": "UrbaneH"}, {"name": "MongoDb"}]).pretty();`
> 
> **è¿™å°±ç±»ä¼¼äº WHERE age > 50 AND (name = â€œUrbaneHâ€ OR name = â€œMongoDBâ€);**



4
æ•°ç»„ä¸­æŸ¥è¯¢
db.collectionName.find({shuzu: "baohanneirong"})
â¬†ï¸è¡¨ç¤ºæŸ¥è¯¢shuzuä¸­çš„æ•°ç»„åŒ…å«baohanneirongçš„æ–‡æ¡£
åªéœ€è¦ä½¿ç”¨åŒ…å«æ•°ç»„çš„å­—æ®µä½œä¸ºé”®ï¼Œè¦åŒ…å«çš„å€¼ä½œä¸ºå€¼å°±å¯ä»¥äº†;
db.collectionName.find({shuzu: {$size: 3}});
â¬†ï¸è¡¨ç¤ºæŸ¥è¯¢shuzué•¿åº¦ä¸º3çš„æ•°æ®


5
æ¨¡ç³ŠæŸ¥è¯¢

**åœ¨MongoDBä¸­ï¼Œæ¨¡ç³ŠæŸ¥è¯¢æ˜¯ä¾é æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ¥è¿›è¡Œå®ç°çš„ï¼›**
**ä»¥æ–œæ å¼€å¤´ä»¥æ–œæ ç»“å°¾ï¼Œä¸éœ€è¦ä½¿ç”¨åŒå¼•å·åŒ…è£¹å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚:**
`db.collectionName.find(name: {/U/})ï¼›`
**â¬†ï¸è¡¨ç¤ºæŸ¥è¯¢nameä¸­åŒ…å«Uå­—ç¬¦çš„æ–‡æ¡£


 **å¦‚æœæ˜¯å¯¹äºæ•°ç»„çš„å†…å®¹è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼ŒMongoDBçš„æ­£åˆ™å¯ä»¥ç›´æ¥åŒ¹é…æ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ ï¼›**
**ä¾‹å¦‚ä¸€ä¸ªæ–‡æ¡£ä¸­çš„shuzu: [â€œåƒé¥­â€ï¼Œ â€œå–æ°´â€ï¼Œâ€œç¡è§‰â€]**
`db.collectionName.find({shuzu: {/åƒ/}});`
**â¬†ï¸ä¹Ÿå¯ä»¥åŒ¹é…åˆ°**

7
æ’åº
`db.collectionName.sort({key1: 1, key2: -1});`
**1æ˜¯å‡åºï¼Œ-1æ˜¯é™åº**

8 
åˆ†é¡µ
db.collectionName.find().sort({query}).limit(rows).skip(start);	
1âƒ£ï¸ sort å…ˆæ ¹æ®éœ€è¦çš„æ¡ä»¶æ’åºï¼›
2âƒ£ï¸ limit æ˜¯è®²æ¯é¡µåˆ†ä¸ºå¤šå°‘æ¡æ•°æ®ï¼›
3âƒ£ï¸ skip æ˜¯æŒ‡å½“å‰æ˜¾ç¤ºç¬¬å‡ é¡µï¼›

9
æ€»æ¡æ•°
db.collectionName.count();
db.collectionName.find({query}).counu();


10
å»é‡
db.collectionName.distinct("å­—æ®µ");
è¿”å›å€¼æ˜¯å¯¹åº”å­—æ®µçš„å‰©ä½™çš„å€¼ï¼ˆå»é‡åï¼‰;


11
è¿”å›æŒ‡å®šå­—æ®µ
è¿™ä¹Ÿæ˜¯ä¸Šæ–‡ä¸­æåˆ°çš„ projection çš„å†…å®¹ï¼›
db.collectionName.find({name: "UrbaneH"}, {age: 0});
â¬†ï¸è¡¨ç¤ºæŸ¥è¯¢é›†åˆä¸­nameçš„å€¼ä¸ºUrbaneHçš„æ•°æ®ï¼Œä½†ä¸è¿”å›ageå­—æ®µï¼›
âš ï¸æ³¨æ„:
0å’Œ1ä¸å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼›0ï¼šä¸è¿”å›ï¼›1ï¼šè¿”å›ï¼›
å¦‚æœä½¿ç”¨äº†0åˆ™é™¤äº†å…¶å­—æ®µå…¶ä½™éƒ½è¿”å›ï¼Œå¦‚æœä½¿ç”¨äº†1åˆ™ä»…è¿”å›å…¶å­—æ®µ





## 5.2 èšåˆç®¡é“æŸ¥è¯¢



å¥½äº†ï¼Œå¦‚æœä½ æƒ³è¦å®ç°æ›´å¤æ‚çš„æŸ¥è¯¢æ“ä½œï¼Œåˆ™å¯ä»¥é€šè¿‡`MongoDB`æä¾›çš„èšåˆç®¡é“æ¥å®Œæˆï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```JavaScript
db.collection.aggregate(
   pipeline: [ <stage>, <...> ],
   options: {
     explain: <boolean>,
     allowDiskUse: <boolean>,
     cursor: <document>,
     maxTimeMS: <int>,
     bypassDocumentValidation: <boolean>,
     readConcern: <document>,
     collation: <document>,
     hint: <string or document>,
     comment: <any>,
     writeConcern: <document>,
     let: <document> // Added in MongoDB 5.0
   }
);
```

èšåˆç®¡é“æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ•°ç»„å‹çš„èšåˆæ“ä½œï¼Œç¬¬äºŒä¸ªæ˜¯å¯é€‰é¡¹ï¼Œ


### 5.2.1 å¯é€‰é¡¹ option 
å…ˆè§£é‡Šä¸‹å¸¸ç”¨çš„é€‰é¡¹ï¼š

- `explain`ï¼šä¼ `true`è¡¨ç¤ºè¿”å›èšåˆç®¡é“çš„è¯¦ç»†æ‰§è¡Œè®¡åˆ’ï¼›
- `allowDiskUse`ï¼šæ˜¯å¦å…è®¸ä½¿ç”¨ç¡¬ç›˜è¿›è¡Œèšåˆæ“ä½œï¼Œå†…å­˜ä¸è¶³æ—¶ä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶è¿›è¡Œè®¡ç®—ï¼›
- `maxTimeMS`ï¼šæŒ‡å®šèšåˆæ“ä½œçš„æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆå•ä½`ms`ï¼‰ï¼Œè¶…æ—¶ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢ï¼›
- `hint`ï¼šæ˜¾å¼æŒ‡å®šä½¿ç”¨é‚£äº›ç´¢å¼•è¿›è¡Œèšåˆæ“ä½œï¼›


### 5.2.2 èšåˆæ“ä½œ pipeline 

ç®€å•äº†è§£å‡ ä¸ªå¸¸ç”¨é€‰é¡¹åï¼Œæˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ä¸€ä¸‹`pipeline`å‚æ•°ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```JavaScript
db.collection.aggregate([
  // é˜¶æ®µ1
  {$stage1: { /* é˜¶æ®µ1çš„æ“ä½œ */ }},
  // é˜¶æ®µ2
  {$stage2: { /* é˜¶æ®µ2çš„æ“ä½œ */ }},
  // ...
]);
```

è§‚å¯Ÿä¸Šè¿°è¯­æ³•ï¼Œé¦–å…ˆå’±ä»¬éœ€è¦æŒ‡å®šæ“ä½œç¬¦ï¼Œè¿™æ˜¯ä¸ºäº†å£°æ˜å½“å‰é˜¶æ®µçš„ç±»å‹ï¼Œä¾‹å¦‚`$group`ï¼Œæ¥ç€å¯ä»¥æŒ‡å®šæ¯ä¸ªé˜¶æ®µå…·ä½“è¦åšçš„äº‹æƒ…ã€‚åŒæ—¶ï¼Œèšåˆç®¡é“ä¸­çš„æ¯ä¸ªé˜¶æ®µï¼Œéƒ½ä¼šå°†ä¸Šä¸€é˜¶æ®µè¾“å‡ºçš„æ•°æ®ï¼Œè§†ä¸ºå½“å‰é˜¶æ®µè¾“å…¥çš„æ•°æ®ï¼Œå’Œ`Stream`æµç±»ä¼¼ï¼Œä¸‹é¢ä¸Šäº›ä¾‹å­ç†è§£ï¼Œå¦‚ä¸‹ï¼š

```JavaScript
/* æŒ‰å¹´é¾„è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡å„ç»„çš„æ•°é‡ï¼ˆæ²¡æœ‰ageå­—æ®µçš„æ•°æ®ç»Ÿè®¡åˆ°ä¸€ç»„ï¼‰ */
db.xiong_mao.aggregate([
    // 1ï¼šé€šè¿‡$groupåŸºäºageåˆ†ç»„ï¼Œé€šè¿‡$sumå®ç°å¯¹å„ç»„+1çš„æ“ä½œ
    {$group: {_id:"$age", count: {$sum:1}}},
    // 2ï¼šåŸºäºå‰é¢çš„_idï¼ˆåŸageå­—æ®µï¼‰è¿›è¡Œæ’åºï¼Œ1ä»£è¡¨æ­£åº
    {$sort: {_id:1}}
]);

/* æŒ‰å¹´é¾„è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å¾—å‡ºæ¯ç»„æœ€å¤§çš„_idå€¼ */
db.xiong_mao.aggregate([
    // 1ï¼šå…ˆåŸºäºageå­—æ®µåˆ†ç»„ï¼Œå¹¶é€šè¿‡$maxå¾—åˆ°æœ€å¤§çš„idï¼Œå­˜åˆ°max_idå­—æ®µä¸­
    {$group: {_id:"$age", max_id: {$max:"$_id"}}},
    // 2ï¼šæŒ‰ç…§å‰é¢çš„_idï¼ˆåŸageå­—æ®µï¼‰è¿›è¡Œæ’åºï¼Œ-1ä»£è¡¨å€’åº
    {$sort: {_id: -1}}
]);

/* è¿‡æ»¤æ‰é£Ÿç‰©ä¸ºç©ºçš„æ•°æ®ï¼Œå¹¶æŒ‰é£Ÿç‰©ç­‰çº§åˆ†ç»„ï¼Œè¿”å›æ¯ç»„_idæœ€å¤§çš„ç†ŠçŒ«å§“å */
db.xiong_mao.aggregate([
    // 1ï¼šé€šè¿‡$matchæ“ä½œç¬¦è¿‡æ»¤foodä¸å­˜åœ¨çš„æ•°æ®
    {$match: {food: {$exists:true}}},
    // 2ï¼šé€šè¿‡$sortæ“ä½œç¬¦ï¼ŒåŸºäº_idå­—æ®µè¿›è¡Œå€’æ’åº
    {$sort: {_id: -1}},
    // 3ï¼šé€šè¿‡$groupåŸºäºé£Ÿç‰©ç­‰çº§åˆ†ç»„ï¼Œå¹¶é€šè¿‡$maxå¾—åˆ°_idæœ€å¤§çš„æ•°æ®ï¼Œ
    // å¹¶é€šè¿‡$firstæ‹¿åˆ°åˆ†ç»„åç¬¬ä¸€æ¡æ•°æ®ï¼ˆ_idæœ€å¤§ï¼‰çš„nameå€¼
    {$group: {_id:"$food.grade", max_id: {$max:"$_id"}, name:{$first: "$name"}}},
    // 4ï¼šæœ€åé€šè¿‡$projectæ“ä½œç¬¦ï¼Œåªæ˜¾ç¤º_idï¼ˆåŸfood.gradeï¼‰ã€nameå­—æ®µ
    {$project: {_id:"$_id", name:1}}
]);
```

ä¸Šé¢ä¸¾äº†ä¸‰ä¸ªç®€å•çš„èšåˆæ“ä½œä¾‹å­ï¼Œä½†ç›¸ä¿¡å¯¹äºç»å¤§å¤šæ•°åˆšæ¥è§¦çš„å°ä¼™ä¼´æ¥è¯´ï¼Œè¿™äº›è¯­å¥çœ‹èµ·æ¥ååˆ†å¤´å¤§ï¼Œä¸€çœ¼æœ›è¿‡å»å…¨éƒ½æ˜¯ç¬¦å·+ç¬¦å·ï¼Œè¿™æ˜¯å› ä¸º`MongoDB`ä¸­ï¼Œä½¿ç”¨æ“ä½œç¬¦ä»£æ›¿äº†`SQL`ä¸­çš„å‡½æ•°ä¸å…³é”®å­—ï¼Œæ‰€ä»¥è¶Šæ˜¯å¤æ‚çš„åœºæ™¯ï¼Œä½¿ç”¨åˆ°çš„æ“ä½œç¬¦è¶Šå¤šï¼Œå¯¹ä¼ ç»Ÿå‹çš„`SQL Boy`æ¥è¯´ï¼Œå¯è¯»æ€§ä¼šè¶Šå·®~


### 5.2.3 æ“ä½œç¬¦

è¿™é‡Œä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œå…ˆåˆ—å‡º`MongoDB`èšåˆç®¡é“æ“ä½œç¬¦å’Œ`SQL`èšåˆå…³é”®å­—/å‡½æ•°çš„å¯¹æ¯”ï¼š

|SQLå…³é”®å­—/å‡½æ•°|MongoDBèšåˆæ“ä½œç¬¦|
|:-:|:-:|
|`whereã€having`|`$match`|
|`group by`|`$group`|
|`order by`|`$sort`|
|`select field1ã€field2â€¦`|`$project`|
|`limit`|`$limitã€$skip`|
|`sum()ã€count()ã€avg()ã€max()ã€min()`|`$sumã€$sum:1ã€$avgã€$maxã€$min`|
|`join`|`$lookup`|

![](image/Pasted%20image%2020250226220058.png)


å½“ç„¶ï¼Œä¸Šé¢åˆ—å‡ºçš„ä»…æ˜¯æ²§æµ·ä¸€ç²Ÿï¼Œ`MongoDB`çš„èšåˆç®¡é“ä¸­å¯ç”¨çš„æ“ä½œç¬¦æœ‰å‡ ç™¾ä¸ªï¼Œä¸ç®¡æ˜¯`SQL`ä¸­æœ‰çš„ï¼Œè¿˜æ˜¯æ²¡æœ‰çš„åŠŸèƒ½/å‡½æ•°ï¼Œéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„æ“ä½œç¬¦ä»£æ›¿ï¼Œå…·ä½“å¤§å®¶å¯ä»¥å‚è€ƒ[MongoDBå®˜ç½‘-Aggregation Pipeline Operators](https://link.juejin.cn?target=https%3A%2F%2Fwww.mongodb.com%2Fdocs%2Fv6.0%2Freference%2Foperator%2Faggregation%2F "https://www.mongodb.com/docs/v6.0/reference/operator/aggregation/")ï¼Œæˆ–[MongoDBä¸­æ–‡ç½‘-èšåˆç®¡é“æ“ä½œç¬¦](https://link.juejin.cn?target=https%3A%2F%2Fdocs.mongoing.com%2Fcan-kao%2Fyun-suan-fu%2Faggregation-pipeline-operators "https://docs.mongoing.com/can-kao/yun-suan-fu/aggregation-pipeline-operators")ã€‚









### 5.2.4 æ¡ˆä¾‹ 


1
è®¡ç®—æ¯ä¸ªä½œè€…ç¼–å†™çš„æ–‡ç« æ€»æ•°

```js
{
   _id: ObjectId(7df78ad8902c)
   title: 'MongoDB Overview', 
   description: 'MongoDB is no sql database',
   by_user: 'runoob.com',
   url: 'http://www.runoob.com',
   tags: ['mongodb', 'database', 'NoSQL'],
   likes: 100
},
{
   _id: ObjectId(7df78ad8902d)
   title: 'NoSQL Overview', 
   description: 'No sql database is very fast',
   by_user: 'runoob.com',
   url: 'http://www.runoob.com',
   tags: ['mongodb', 'database', 'NoSQL'],
   likes: 10
},
{
   _id: ObjectId(7df78ad8902e)
   title: 'Neo4j Overview', 
   description: 'Neo4j is no sql database',
   by_user: 'Neo4j',
   url: 'http://www.neo4j.com',
   tags: ['neo4j', 'database', 'NoSQL'],
   likes: 750
},

```

```js
 db.colltectionName.aggregate([{$group : {_id : "$by_user", num_tutorial : {$sum : 1}}}])
{
   "result" : [
      {
         "_id" : "runoob.com",
         "num_tutorial" : 2
      },
      {
         "_id" : "Neo4j",
         "num_tutorial" : 1
      }
   ],
   "ok" : 1
}

```

å°†é›†åˆå†…çš„æ•°æ®è¿›è¡Œåˆ†ç»„
`$group` æ˜¯ç”¨æ¥åˆ†ç»„çš„ï¼Œé‡Œé¢çš„å‚æ•° `__id` ç”¨æ¥å£°æ˜ç”¨åŸæ•°æ®çš„å“ªä¸ªå­—æ®µä½œä¸ºåˆ†ç»„çš„ç´¢å¼•ï¼›â¬†ï¸ğŸŒ°å°±æ˜¯å°† by_user è¿™ä¸ªå­—æ®µè¿›è¡Œåˆ†ç»„èšåˆæ“ä½œï¼Œå¹¶ä¸”è¿™ä¸ªå­—æ®µä½œä¸ºäº†æ–°çš„é›†åˆçš„ç´¢å¼•ï¼›

 
é€‰æ‹©èšåˆå‡½æ•°
`num_tutorial` å‚æ•°ç®€å•ç†è§£å°±æ˜¯å¯¹äºåˆ†ç»„åçš„æ•°æ®ï¼Œèšåˆçš„åŠæ³•ï¼›â¬†ï¸ğŸŒ°å°±æ˜¯é€‰æ‹©äº† `$sum` æ¥ç´¯åŠ ï¼Œç”±äºåŸæ•°æ®ä¸­æ²¡æœ‰æœ‰å…³ä½œè€…æ–‡ç« æ•°é‡çš„ä¿¡æ¯ï¼Œä¸”æ¯ä¸€æ¡æ•°æ®éƒ½æ˜¯ä¸€æ¡æ–‡ç« çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ `$sum: 1` å«ä¹‰å°±æ˜¯æ¯æ¡æ•°æ®ç´¯åŠ  1ã€‚å¦‚æœé€‰æ‹©ç´¯åŠ åŸæ•°æ®çš„å€¼ï¼Œåˆ™åŒæ ·çš„æ–¹æ³•å°±æ˜¯ `$å­—æ®µåç§°`ï¼›

  


---


1 
è¯å½’æ­£é¢˜ï¼Œå’±ä»¬æ¥ç¨å¾®è§£è¯»ä¸€ä¸‹å‰é¢å†™å‡ºçš„èšåˆç®¡é“æŸ¥è¯¢è¯­å¥ï¼Œå…ˆæ‹¿æœ€ç®€å•çš„ç¬¬ä¸€æ¡æ¥è¯´ï¼š

```JavaScript
/* æŒ‰å¹´é¾„è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡å„ç»„çš„æ•°é‡ */
db.xiong_mao.aggregate([
    {$group: {_id:"$age", count: {$sum:1}}},
    {$sort: {_id:1}}
]);
```

åœ¨ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œä½¿ç”¨`$group`æ“ä½œç¬¦æ¥å®Œæˆåˆ†ç»„åŠ¨ä½œï¼Œå…¶ä¸­`_id`å¹¶ä¸æ˜¯åŸæ•°æ®ä¸­çš„`_id`ï¼Œè€Œæ˜¯ä»£è¡¨æƒ³èšåˆçš„æ•°æ®ä¸»é”®ï¼Œä¸Šé¢çš„éœ€æ±‚æƒ³åŸºäºå¹´é¾„åˆ†ç»„ï¼Œæ‰€ä»¥`_id`è®¾ç½®ä¸º`$age`å³å¯ã€‚

> æ³¨æ„ï¼šåœ¨èšåˆæŸ¥è¯¢ä¸­ï¼Œä¹Ÿä¼šä½¿ç”¨`$`æ¥å¼•ç”¨åŸæ•°æ®ä¸­çš„å­—æ®µï¼Œæ¡ˆä¾‹ä¸­çš„`$age`å¹¶ä¸æ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼Œè€Œæ˜¯è·å–åŸæ•°æ®çš„`age`å­—æ®µï¼Œè¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥ç”¨æ¥æ‹¿å…¶ä»–å­—æ®µï¼Œå¦‚`$nameã€$colorâ€¦â€¦`ã€‚

åœ¨ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œå’±ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ª`count`å­—æ®µï¼Œè¿™ç›¸å½“äº`SQL`ä¸­çš„åˆ«åï¼Œè¯¥å­—æ®µçš„å€¼ï¼Œåˆ™æ˜¯ç”±`{$sum:1}`ç»Ÿè®¡å¾—å‡ºçš„ï¼Œè¿™æ®µé€»è¾‘ç›¸å½“äºï¼š

```java
Map<Integer, Integer> groupMap = new HashMap<>();
for (XiongMao xm : xiongMaoList) {
    Integer age = xm.getAge();
    if (groupMap.get(age) == null) {
        groupMap.put(age, 1);
    } else {
        Integer count = groupMap.get(age) + 1;
        groupMap.put(age, count);
    }
}
```

ç¬¬ä¸€é˜¶æ®µçš„åˆ†ç»„ç»Ÿè®¡å·¥ä½œå®Œæˆåï¼Œæ¥ç€ä¼šæ¥åˆ°ç¬¬äºŒé˜¶æ®µï¼Œå…¶ä¸­ä½¿ç”¨äº†`$sort`æ“ä½œç¬¦ï¼Œå¯¹`_id`å­—æ®µè¿›è¡Œäº†å‡åºæ’åºï¼Œä¸è¿‡è¿™é‡Œè¦æ³¨æ„ï¼Œå› ä¸ºç¬¬äºŒé˜¶æ®µè¾“å…¥çš„æ•°æ®ï¼Œæ˜¯ç¬¬ä¸€é˜¶æ®µè¾“å‡ºçš„æ•°æ®ï¼Œæ‰€ä»¥ç¬¬äºŒé˜¶æ®µçš„`_id`ï¼Œå®é™…ä¸Šæ˜¯åŸæœ¬çš„`age`å­—æ®µï¼Œè¿™æ„å‘³ç€åœ¨å¯¹å¹´é¾„åšå‡åºæ’åºï¼


----

2


OKï¼Œç›¸ä¿¡ç»è¿‡è¿™ç•ªè§£é‡Šåï¼Œå¤§å®¶å¯¹`MongoDB`çš„èšåˆç®¡é“æ“ä½œæœ‰äº†ä¸€å®šç†è§£ï¼Œé‚£æ¥ç€ç»§ç»­çœ‹äº›æ¡ˆä¾‹åŠ æ·±å°è±¡ï¼ˆä¹Ÿå¯ä»¥å°è¯•ç€è‡ªå·±ç»ƒä¹ ç»ƒä¹ ï¼‰ï¼š

```JavaScript
/* å¤šå­—æ®µåˆ†ç»„ï¼šæŒ‰é£Ÿç‰©ç­‰çº§ã€é¢œè‰²å­—æ®µåˆ†ç»„ï¼Œå¹¶æ±‚å‡ºæ¯ç»„çš„å¹´é¾„æ€»å’Œ */
db.xiong_mao.aggregate([
    // 1ï¼š_idä¸­å†™å¤šä¸ªå­—æ®µï¼Œä»£è¡¨æŒ‰å¤šå­—æ®µåˆ†ç»„ï¼Œæ¥ç€é€šè¿‡$sumæ±‚å’Œageå­—æ®µ
    {$group: {_id: {grade:"$food.grade", color:"$color"}, total_age: {$sum:"$age"}}}
]);

/* åˆ†ç»„åè¿‡æ»¤ï¼šæ ¹æ®å¹´é¾„åˆ†ç»„ï¼Œç„¶åè¿‡æ»¤æ‰æ•°é‡å°äº3çš„ç»„ */
db.xiong_mao.aggregate([
    // 1ï¼šå…ˆæŒ‰å¹´é¾„è¿›è¡Œåˆ†ç»„ï¼Œå¹¶é€šè¿‡$sum:1å¯¹æ¯ç»„æ•°é‡è¿›è¡Œç»Ÿè®¡
    {$group: {_id: "$age", count: {$sum:1}}},
    // 2ï¼šé€šè¿‡$matchæ“ä½œç¬¦ï¼Œä¿ç•™æ•°é‡>3çš„åˆ†ç»„ï¼ˆè¿‡æ»¤æ‰<3çš„åˆ†ç»„ï¼‰
	{$match: {count: {$gt:3}}}
]);

/* åˆ†ç»„è®¡ç®—ï¼šæ ¹æ®é¢œè‰²åˆ†ç»„ï¼Œæ±‚å‡ºæ¯ç»„çš„æ•°é‡ã€æœ€å¤§/æœ€å°/å¹³å‡å¹´é¾„ã€æ‰€æœ‰å§“åã€é¦–/å°¾çš„å§“å */
db.xiong_mao.aggregate([
    // 1ï¼šæŒ‰é¢œè‰²åˆ†ç»„
    {$group: {_id: "$color", 
        // è®¡ç®—æ¯ç»„æ•°é‡
        count: {$sum:1}, 
        // è®¡ç®—æ¯ç»„æœ€å¤§å¹´é¾„
        max_age: {$max: "$age"},
        // è®¡ç®—æ¯ç»„æœ€å°å¹´é¾„
        min_age: {$min: "$age"},
        // è®¡ç®—æ¯ç»„å¹³å‡å¹´é¾„
        avg_age: {$avg: "$age"},
        // é€šè¿‡$pushæŠŠæ¯ç»„çš„å§“åæ”¾å…¥åˆ°é›†åˆä¸­
        names: {$push:"$name"},
        // è·å–æ¯ç»„ç¬¬ä¸€ä¸ªç†ŠçŒ«çš„å§“å
        first_name: {$first: "$name"},
        // è·å–æ¯ç»„æœ€åä¸€ä¸ªç†ŠçŒ«çš„å§“å
        last_name: {$last: "$name"}}}
]);

/* åˆ†ç»„åä¿ç•™åŸæ•°æ®ï¼Œå¹¶åŸºäºåŸ_idæ’åºï¼Œç„¶åè·³è¿‡å‰3æ¡æ•°æ®ï¼Œæˆªå–5æ¡æ•°æ® */
db.xiong_mao.aggregate([
    // 1ï¼šå…ˆåŸºäºcoloråˆ†ç»„ï¼Œå¹¶é€šè¿‡$$ROOTå¼•ç”¨åŸæ•°æ®ï¼Œå°†å…¶ä¿å­˜åˆ°æ•°ç»„ä¸­
    {$group: {_id: "$color", xiong_mao_list: {$push: "$$ROOT"}}},
    // 2ï¼šé€šè¿‡$unwindæ“ä½œç¬¦ï¼Œå°†xiong_mao_listæ•°ç»„åˆ†è§£æˆä¸€æ¡æ¡æ•°æ®
    {$unwind: {path:'$xiong_mao_list', 
        // ä½¿ç”¨indexå­—æ®µè®°å½•æ•°ç»„ä¸‹æ ‡ï¼ŒpreserveNullAndEmptyArrayså¯ä»¥ä¿è¯ä¸ä¸¢å¤±æ•°æ®
        includeArrayIndex:"index", preserveNullAndEmptyArrays: true}},
    // 3ï¼šåŸºäºåˆ†è§£åçš„_idå­—æ®µè¿›è¡Œæ’åºï¼Œ1ä»£è¡¨å‡åº
    {$sort: {"xiong_mao_list._id": 1}},
    // 4ï¼šé€šè¿‡$skipè·³è¿‡å‰3æ¡æ•°æ®
    {$skip: 3},
    // 5ï¼šé€šè¿‡$limitè·å–5æ¡æ•°æ®
    {$limit: 5}
]);

/* æ ¹æ®å¹´é¾„è¿›è¡Œåˆ¤æ–­ï¼Œå¤§äº3å²æ˜¾ç¤ºæˆå¹´ã€å¦åˆ™æ˜¾ç¤ºæœªæˆå¹´ï¼ˆè¾“å‡ºå§“åã€ç»“æœï¼‰ */
db.xiong_mao.aggregate([
    // 1ï¼šé€šè¿‡$projectæ“ä½œç¬¦æ¥å®ŒæˆæŠ•å½±è¾“å‡º
    {$project: {
      // ä¸æ˜¾ç¤º_idå­—æ®µï¼Œå°†nameå­—æ®µé‡å‘½åä¸ºï¼šâ€œå§“åâ€
      _id:0, å§“å:"$name",
      // é€šè¿‡$condå®ç°é€»è¾‘è¿ç®—ï¼Œå¦‚æœå¹´é¾„>=3ï¼Œæ˜¾ç¤ºæˆå¹´ï¼Œå¦åˆ™æ˜¾ç¤ºæœªæˆå¹´
      result: {
        $cond: {
          if: {$gte: ["$age", 3]},
          then: "æˆå¹´",
          else: "æœªæˆå¹´"
    }}}}
]);
```



### 5.2.5 èšåˆçš„è¦ç‚¹ 

å¥½äº†ï¼Œå…³äºèšåˆç®¡é“çš„æ¡ˆä¾‹ï¼Œæš‚æ—¶å°±å†™åˆ°è¿™é‡Œï¼Œæƒ³è¦å­¦ä¹ å…¶ä»–æ“ä½œç¬¦çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒä¹‹å‰ç»™å‡ºçš„å®˜ç½‘é“¾æ¥ã€‚è¿™é‡Œä¸»è¦è¯´æ˜å‡ ç‚¹è¦ç´ ã€‚

é¦–å…ˆèšåˆç®¡é“çš„æ¯ä¸ªé˜¶æ®µï¼Œå†…å­˜é™åˆ¶ä¸€èˆ¬ä¸º`100MB`ï¼Œå¦‚æœè¶…å‡ºè¿™ä¸ªé™åˆ¶ï¼Œæ‰§è¡Œæ—¶ä¼šæŠ¥é”™ï¼Œå› æ­¤å½“éœ€è¦å¤„ç†å¤§å‹æ•°æ®é›†æ—¶ï¼Œè®°å¾—æŠŠ`allowDiskUse`é€‰é¡¹ç½®ä¸º`true`ï¼Œå…è®¸`MongoDB`ä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶æ¥å®Œæˆè®¡ç®—ã€‚

å…¶æ¬¡å‘¢ï¼Œä½¿ç”¨èšåˆç®¡é“æ—¶ä¹Ÿè¦ç‰¢è®°ï¼Œç­›é€‰ã€è¿‡æ»¤ç±»å‹çš„é˜¶æ®µï¼Œæœ€å¥½æ”¾åˆ°å‰é¢å®Œæˆï¼Œè¿™æ ·æœ‰ä¸¤ä¸ªå¥½å¤„ï¼šä¸€æ˜¯å¯ä»¥å¿«é€Ÿå°†ä¸éœ€è¦çš„æ–‡æ¡£è¿‡æ»¤æ‰ï¼Œå‡å°‘ç®¡é“åç»­é˜¶æ®µçš„å·¥ä½œé‡ï¼›äºŒæ˜¯å¦‚æœåœ¨`$projectã€$group`è¿™ç±»æ“ä½œå‰æ‰§è¡Œ`$match`ï¼Œ`$match`é˜¶æ®µå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œå› ä¸ºæ­¤æ—¶å±äºåœ¨æ“ä½œåŸæœ¬çš„æ–‡æ¡£ï¼Œç´¢å¼•è‡ªç„¶ä¸ä¼šå¤±æ•ˆï¼Œå¯å¦‚æœæ”¾åˆ°`$projectã€$groupâ€¦â€¦`åé¢å†æ‰§è¡Œï¼ŒåŸæ•°æ®è¢«æ”¹å˜åï¼Œå‰é¢çš„é˜¶æ®µä¼šå½¢æˆæ–°çš„æ–‡æ¡£ï¼Œå¹¶è¾“å‡ºåˆ°`$match`é˜¶æ®µä¸­ï¼Œè¿™æ—¶ç´¢å¼•ä¸ä¸€å®šèƒ½ç»§ç»­ç”Ÿæ•ˆã€‚

æœ€åï¼ŒæŒ‰å®˜ç½‘æ‰€è¯´ï¼Œé™¤äº†`$outã€$merge`å’Œ`$geoNear`è¿™äº›é˜¶æ®µå¤–ï¼Œå…¶ä»–ç±»å‹çš„æ‰€æœ‰é˜¶æ®µï¼Œéƒ½å¯ä»¥åœ¨ç®¡é“ä¸­å‡ºç°å¤šæ¬¡ï¼Œè¿™æ„å‘³ç€`MongoDB`ä¼šæ¯”ä¼ ç»Ÿå‹`SQL`æ›´å¼ºå¤§ï¼Œæ¯”å¦‚å¯ä»¥å¤šæ¬¡åˆ†ç»„ã€ç­›é€‰â€¦â€¦ï¼Œç»“åˆç®¡é“é‡Œçš„å‡ ç™¾ä¸ªæ“ä½œç¬¦ï¼Œä½ å¯ä»¥å®ç°å„ç§å¤æ‚åœºæ™¯ä¸‹çš„èšåˆæ“ä½œã€‚


# 6 åµŒå¥—æ–‡æ¡£çš„å¢åˆ æ”¹æŸ¥

åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‘è¡¨ã€ä¸»å­è¡¨ç­‰æ€æƒ³ï¼ŒæŠ½è±¡å‡ºå„ç§ç»“æ„ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œä¸¾ä¸ªä¾‹å­ç†è§£ï¼Œæ¯”å¦‚ä¸‹å•ä¸šåŠ¡ä¸­ï¼Œç”¨æˆ·ä¸€ç¬”è®¢å•å¯èƒ½ä¼šåŒ…å«å¤šä¸ªå•†å“ï¼Œæ‰€ä»¥ä¼šç”¨ä¸»å­è¡¨çš„æ€æƒ³ï¼Œå¯¹è®¢å•æ•°æ®è¿›è¡Œå­˜å‚¨ï¼Œè®¢å•æ•°æ®å­˜åˆ°ä¸»è¡¨ä¸­ã€è®¢å•è¯¦æƒ…æ•°æ®æ”¾åˆ°å­è¡¨ï¼Œä¸¤è¡¨ä¹‹é—´é€šè¿‡ä¸»å¤–é”®å…³è”ï¼Œåç»­å¯ä»¥é€šè¿‡`join`æ¥æŸ¥è¯¢ã€ä½¿ç”¨ã€‚

ä½†ç”±äº`MongoDB`æ˜¯æ— æ¨¡å¼ã€åŠç»“æ„åŒ–çš„å­˜å‚¨æ–¹å¼ï¼Œå› æ­¤æ— æ³•åƒä¼ ç»Ÿå‹æ•°æ®åº“é‚£æ ·ï¼Œé€šè¿‡ä¸»å¤–é”®æ¥å…³è”ä¸åŒè¡¨ï¼ˆé›†åˆï¼‰ï¼Œæ¯•ç«Ÿä¸€ä¸ªé›†åˆæ²¡æœ‰æ˜ç¡®çš„å­—æ®µå®šä¹‰ï¼Œå¯ä»¥éšæ„æ’å…¥ä¸åŒå­—æ®µã€‚é‚£`MongoDB`åˆè¯¥å¦‚ä½•æ»¡è¶³æ ‘è¡¨ã€ä¸»å­è¡¨è¿™ç§ä¸šåŠ¡çš„å­˜å‚¨éœ€æ±‚å‘¢ï¼Ÿ**ç­”æ¡ˆæ˜¯é€šè¿‡æ–‡æ¡£åµŒå¥—æ¥ä»£æ›¿ï¼**

åœ¨å‰é¢å­¦ä¹ `insert`æ“ä½œæ—¶ï¼Œå¤§å®¶ä¸éš¾å¾—çŸ¥ï¼š`MongoDB`é›†åˆä¸­çš„æ¯ä¸ªå­—æ®µï¼Œå¯ä»¥ç»§ç»­åµŒå¥—`Json`å¯¹è±¡ï¼Œå› ä¸º`MongoDB`æœ¬èº«å°±æ˜¯ä»¥`Json`æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥åªè¦æ˜¯èƒ½ç”¨`Json`æ ¼å¼è¡¨è¾¾å‡ºæ¥çš„æ•°æ®ï¼Œéƒ½å¯ä»¥æ”¾åˆ°é›†åˆä¸­å­˜å‚¨ï¼Œæ¯”å¦‚ï¼š

```JavaScript
db.xiong_mao.insert([
    {_id:12, name:"é‡‘ç†Š", age:4, hobby:["åƒé¥­","ç¡è§‰"], food:{name:"é»„é‡‘ç«¹", grade:"S"}}
]);
```

åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œå­—æ®µçš„å€¼å¯ä»¥æ”¾å…¥æ™®é€šç±»å‹ï¼Œä¹Ÿå¯ä»¥æ”¾å…¥æ•°ç»„ã€å¦ä¸€ä¸ª`Json`å¯¹è±¡ï¼Œæ‰€ä»¥æ—©æœŸçš„`MongoDB`ï¼Œæ¨èé€šè¿‡åµŒå…¥æ–‡æ¡£ï¼Œæ¥ä»£æ›¿`SQL`ä¸­çš„`join`å¤šè¡¨è¿æ¥æŸ¥è¯¢ï¼Œå‰é¢ä¸¾ä¾‹æåˆ°çš„è®¢å•ã€è®¢å•è¯¦æƒ…è¿™ç§ä¸€å¯¹å¤šçš„ä¸»å­å…³ç³»ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ä»£æ›¿ï¼š


ä¸‹é¢æ¥èŠèŠåµŒå¥—æ–‡æ¡£çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿™é‡Œè·Ÿæ“ä½œæ™®é€šæ–‡æ¡£æœ‰äº›è®¸å‡ºå…¥ï¼Œå¦‚ä¸‹ï¼š

```JavaScript
/* æ–°å¢å•æ¡è®¢å•è¯¦æƒ…ï¼šé€šè¿‡orderé›†åˆçš„updateæ–¹æ³•æ¥å®ç° */
db.order.update(
    // ä¿®æ”¹æ¡ä»¶ï¼šä¿®æ”¹_id=1çš„è®¢å•æ•°æ®
    {_id: 1},
    // é€šè¿‡$pushæ“ä½œç¬¦ï¼Œå¾€order_detailsä¸­å‹å…¥ä¸€æ¡æ–°è®°å½•
    {$push: {
      order_details: {
        order_detail_id: 3,
        shop_id: 4,
        shop_price: 444.44,
        status: "å¾…å‘è´§"
        }
    }}
);

/* æ–°å¢å¤šæ¡è®¢å•è¯¦æƒ…è®°å½• */
db.order.update(
  {_id: 1},
  {$push: {
      order_details: {
        // è¿™é‡Œä½¿ç”¨$eachæ“ä½œç¬¦ï¼Œå£°æ˜æœ¬æ¬¡è¦pushå¤šä¸ªå…ƒç´ 
        $each: [
          {order_detail_id: 4, shop_id: 3, shop_price: 333.33, status: "å¾…å‘è´§"},
          {order_detail_id: 5, shop_id: 1, shop_price: 111.11, status: "å¾…å‘è´§"}
        ]
      }
	}}
);

/* åˆ é™¤æ»¡è¶³æ¡ä»¶çš„è®¢å•è¯¦æƒ…æ•°æ® */
db.order.update(
  {_id: 1},
  // é€šè¿‡$pullæ“ä½œç¬¦ï¼Œå°†order_detailsæ»¡è¶³æ¡ä»¶çš„æ•°æ®å¼¹å‡º
  {$pull: {
      // åˆ é™¤order_detail_idå¤§äº3çš„è®¢å•è¯¦æƒ…æ•°æ®
      order_details: {order_detail_id: {$gt:3}}
    }
});

/* ä¿®æ”¹å•æ¡æ»¡è¶³æ¡ä»¶çš„è®¢å•è¯¦æƒ…æ•°æ® */
db.order.update(
  // è¿™é‡Œç»™å®šäº†ä¸¤ä¸ªæ¡ä»¶ï¼Œè®¢å•ID=1ï¼Œå¹¶ä¸”è®¢å•è¯¦æƒ…ID=1
  {_id: 1, "order_details.order_detail_id": 1},
  // é€šè¿‡$setæ“ä½œç¬¦ï¼Œæ¥å¯¹é›†åˆä¸­çš„æ–‡æ¡£è¿›è¡Œå±€éƒ¨ä¿®æ”¹
  {$set: {
      // å°†çŠ¶æ€æ”¹ä¸ºå·²å‘è´§ï¼Œè¿™é‡Œçš„$ï¼Œè¡¨ç¤ºæ•°ç»„ä¸­çš„å½“å‰å…ƒç´ ï¼Œå³æ¡ä»¶åŒ¹é…çš„æ•°ç»„å…ƒç´ 
      "order_details.$.status": "å·²å‘è´§"
  }}
);

/* ä¿®æ”¹å¤šæ¡æ»¡è¶³æ¡ä»¶çš„è®¢å•è¯¦æƒ…æ•°æ® */ 
db.order.update(
  // å…ˆæŸ¥è¯¢åˆ°è®¢å•ID=1çš„æ•°æ®
  {_id: 1},
  {$set: {
      // è¿™é‡Œä½¿ç”¨çš„æ˜¯$[elem]å ä½ç¬¦ï¼Œä»£è¡¨ç€è¦æ›´æ–°çš„å…ƒç´ 
      "order_details.$[elem].status": "å·²å‘è´§"
  }},
  // è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæ•°ç»„è¿‡æ»¤å™¨ï¼Œä¼šæŠŠæ»¡è¶³æ¡ä»¶çš„è®¢å•è¯¦æƒ…è®°å½•ç­›é€‰å‡ºæ¥
  {arrayFilters: [
        // è¿™é‡Œçš„elemä»£è¡¨æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œè¿‡æ»¤æ¡ä»¶ä¸ºï¼šè®¢å•è¯¦æƒ…ID=2ã€3çš„æ•°æ®
    	{"elem.order_detail_id": {$in: [2,3]}}
    ]}
);

/* ä¿®æ”¹æ»¡è¶³å¤šä¸ªæ¡ä»¶çš„å•æ¡æ•°æ® */
db.order.update(
  {
    // è¿™é‡Œæ˜¯åŸºäºorder_detailså­—æ®µåœ¨åšæ¡ä»¶è¿‡æ»¤ï¼Œå¯ä»¥è·¨æ–‡æ¡£ï¼ˆåœ¨ä¸åŒæ•°æ®è¡Œä¸­ç­›é€‰ï¼‰
    order_details: {
      // $elemMatchæ“ä½œç¬¦ä»£è¡¨åŒ¹é…å¤šä¸ªæ¡ä»¶
      $elemMatch: {
        status: "å·²å‘è´§",
        shop_id: 2
    }}
  },
  // å¯¹æ»¡è¶³å¤šä¸ªæ¡ä»¶çš„å•æ¡æ•°æ®è¿›è¡Œä¿®æ”¹ï¼ˆè¦ä¿®æ”¹å¤šæ¡ï¼Œå‚è€ƒä¸Šä¸ªæ¡ˆä¾‹çš„ç”¨æ³•å³å¯ï¼‰
  {$set: {
      "order_details.$.status": "å·²ç­¾æ”¶"
  }}
);

/* æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å•æ¡æ•°æ® */
db.order.find(
    // æŸ¥è¯¢order_detail_id==1çš„è®¢å•è¯¦æƒ…æ•°æ®
    {"order_details.order_detail_id":1}, 
    // é™åˆ¶è¿”å›çš„å­—æ®µï¼Œä¸è¿”å›_idï¼Œorder_details.$è¡¨ç¤ºåªè¿”å›æ»¡è¶³æ¡ä»¶çš„è®¢å•è¯¦æƒ…æ•°æ®
    {"_id":0, "order_details.$":1}
);

/* æŸ¥è¯¢æ»¡è¶³å¤šä¸ªæ¡ä»¶çš„å¤šæ¡æ•°æ® */
db.order.aggregate([
    // ä½¿ç”¨$projectæ“ä½œç¬¦å®ŒæˆæŠ•å½±æŸ¥è¯¢
    {$project: {
      // ä¸è¿”å›_idå­—æ®µ
      _id: 0,
      // åªè¿”å›order_detailså­—æ®µ
      order_details: {
        // é€šè¿‡$filteræ“ä½œç¬¦ï¼Œå®ç°æŒ‰æ¡ä»¶è¿‡æ»¤æ•°æ®
        $filter: {
          // è¿™é‡Œç›¸å½“äºforå¾ªç¯ï¼Œ$order_detailsæ˜¯è¦éå†çš„æ•°ç»„ï¼Œ$detailæ˜¯åˆ«å
          input: "$order_details",
          as: "detail",
          // è¿™é‡Œæ˜¯è¿‡æ»¤çš„æ¡ä»¶ï¼Œ$andè¡¨ç¤ºä¸¤ä¸ªæ¡ä»¶éƒ½éœ€è¦æ»¡è¶³
          cond: {
            $and: [
              // è¿”å›order_detail_id>=1 && statusä¸ºâ€œå·²ç­¾æ”¶â€çš„æ•°æ®
              {$gte: ["$$detail.order_detail_id", 1]},
              {$eq: ["$$detail.status", "å·²ç­¾æ”¶"]}
            ]
          }
        }
    }}}
]);
```

å¥½äº†ï¼Œä¸Šé¢æŠŠåµŒå¥—æ–‡æ¡£çš„å¢åˆ æ”¹æŸ¥æ“ä½œç®€å•è¿‡äº†ä¸€éï¼Œå…¶å®åµŒå…¥å¼æ–‡æ¡£çš„`CRUD`ï¼Œéƒ½ä¾èµ–äºå¤–éƒ¨é›†åˆçš„`CRUD`æ–¹æ³•å®Œæˆï¼Œå”¯ä¸€æœ‰åŒºåˆ«çš„åœ°æ–¹å°±åœ¨äºï¼šæˆ‘ä»¬éœ€è¦ç»“åˆ`$pushã€$pullã€$elemMatchã€$[elem]`ç­‰å„ç§æ•°ç»„æ“ä½œç¬¦ï¼Œæ¥å®ç°åµŒå…¥å¼æ–‡æ¡£çš„å¢åˆ æ”¹æŸ¥ã€‚

---


ä¸è¿‡å¦‚è‹¥åªåµŒå…¥äº†ä¸€ä¸ªæ–‡æ¡£ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ–‡æ¡£æ•°ç»„æ—¶ï¼Œæ“ä½œçš„æ–¹æ³•æœ‰æœ‰äº›ä¸åŒï¼Œå¦‚ä¸‹ï¼š

```JavaScript
// ä»¥ä¹‹å‰xiong_maoé›†åˆä¸­ï¼Œid=1çš„è¿™æ¡æ•°æ®ä¸ºä¾‹
db.xiong_mao.insert({_id:1, name:"è‚¥è‚¥", age:3, hobby:"ç«¹å­"});

// ä¸ºå…¶æ·»åŠ ä¸€ä¸ªå†…åµŒæ–‡æ¡£
db.xiong_mao.update(
	{_id:1},
	{$set: {food: {name:"å¸ç‹ç«¹", grade:"A"}}}, 
	{upsert:true}
);

// æŸ¥è¯¢ä¸€æ¬¡çœ‹çœ‹è¿™æ¡æ•°æ®ï¼ˆæ­¤æ—¶å¯ä»¥çœ‹åˆ°å†…åµŒæ–‡æ¡£å·²ç»è¢«æ·»åŠ ï¼‰
db.xiong_mao.find({_id:1});
{
    _id: 1,
    name: 'è‚¥è‚¥',
    age: 3,
    hobby: 'ç«¹å­',
    color: 'é»‘ç™½è‰²',
    food: { name: 'å¸ç‹ç«¹', grade: 'A' }
}

// ä¿®æ”¹å†…åµŒæ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼
db.xiong_mao.updateMany(
	{_id:1},
	// ä¿®æ”¹å•ä¸ªå­—æ®µï¼Œè¦ç”¨ . çš„å½¢å¼
	{$set: {"food.grade":"S"}}, 
	{upsert:true}
);

// åˆ é™¤å†…åµŒæ–‡æ¡£ä¸­çš„å•ä¸ªå­—æ®µ
db.xiong_mao.update(
    {_id:1},
    // é€šè¿‡$unsetæ“ä½œç¬¦ï¼Œå°†å¯¹åº”å­—æ®µç½®ä¸ºç©ºå³å¯
    {$unset:{"food.grade":""}},
    {upsert:true}
);

// åˆ é™¤æ•´ä¸ªå†…åµŒæ–‡æ¡£
db.xiong_mao.update(
    {_id:1},
    // å°†æ•´ä¸ªå†…åµŒæ–‡æ¡£å­—æ®µç½®ä¸ºç©ºå³å¯
    {$unset:{food:""}},
    {upsert:true}
);
```

okï¼Œå…³äºæ–‡æ¡£åµŒå…¥çš„å†…å®¹å’±ä»¬å…ˆå°±æ­¤æ‰“ä½ï¼Œæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š**çœŸçš„æ‰€æœ‰å¸¦æœ‰ä¸»å¤–é”®å…³ç³»çš„ç»“æ„ï¼Œéƒ½å¯ä»¥é€šè¿‡æ–‡æ¡£åµŒå…¥ä»£æ›¿å—ï¼Ÿ**

è¿™ä¸ªç­”æ¡ˆæ˜æ˜¾æ˜¯`NO`ï¼Œä¸ºä»€ä¹ˆï¼Ÿå°±æ‹¿å’±ä»¬å‰é¢â€œè®¢å•-è®¢å•è¯¦æƒ…â€ä¾‹å­ä¸­çš„å•†å“æ¥è¯´ï¼Œæ¯ä¸€ç¬”è®¢å•è¯¦æƒ…è®°å½•ï¼Œéƒ½éœ€è¦è·Ÿå•†å“äº§ç”Ÿç»‘å®šå…³ç³»å§ï¼Ÿè¿™æ—¶æˆ‘ä»¬æ€»ä¸èƒ½æŠŠæ•´ä¸ªå•†å“çš„æ•°æ®ï¼Œå…¨éƒ¨åµŒå…¥åˆ°è®¢å•è¯¦æƒ…çš„æŸä¸ªå­—æ®µä¸­å§ï¼Ÿå› ä¸ºä¸€ä¸ªå•†å“å¯ä»¥è¢«å¤šæ¬¡è´­ä¹°ï¼å¦‚æœçœŸæŒ‰è¿™æ ·å­˜ï¼Œå‡è®¾ä¸€ä¸ªå•†å“å•æœˆé”€é‡`10W+`ï¼Œäº§ç”Ÿçš„`10W+`è®¢å•è¯¦æƒ…è®°å½•ï¼Œéš¾é“éƒ½æŠŠè¿™ä¸ªå•†å“çš„å®Œæ•´æ•°æ®åµŒå…¥ä¸€æ¬¡å—ï¼Ÿæ˜¾ç„¶ä¸åˆç†ã€‚

æ­£å› å¦‚æ­¤ï¼Œæœ‰äº›åœºæ™¯ä¸‹ï¼Œå’±ä»¬æ— æ³•é€šè¿‡æ–‡æ¡£åµŒå…¥æ¥ä»£æ›¿åŸæœ¬çš„å¤šè¡¨å…³è”ï¼Œæ‰€ä»¥`MongoDB`åœ¨`3.2`ç‰ˆæœ¬ä»¥åï¼Œä¹Ÿæ”¯æŒäº†å¤šä¸ªé›†åˆä¹‹é—´å…³è”æŸ¥è¯¢ï¼Œå°±ç±»ä¼¼äº`SQL`ä¸­çš„`join`ä¸€æ ·ï¼åªä¸è¿‡åŠŸèƒ½æ²¡`SQL`å¼ºå¤§ï¼Œå¹¶ä¸”å¿…é¡»åœ¨èšåˆç®¡é“ä¸­ä½¿ç”¨ï¼Œä¸‹é¢ä¸€èµ·æ¥çœ‹çœ‹ã€‚

## 6.1 å¤šä¸ªé›†åˆå…³è”æŸ¥è¯¢


ç°åœ¨å‡è®¾æœ‰å•†åº—`shop_store`ã€å•†å“`product`ä¸¤ä¸ªé›†åˆï¼Œæ•°æ®å¦‚ä¸‹ï¼š

```JavaScript
db.shop_store.insertMany([
    {_id: 1, name: "ç†ŠçŒ«é«˜çº§ä¼šæ‰€", address:"åœ°çƒå¸‚å¤©ä¸Šäººé—´è¡—é“888å·", grade:"äº”æ˜Ÿ"},
    {_id: 2, name: "ç«¹å­å•†åº—", address:"åœ°çƒå¸‚ç»¿ç«¹æ—è¡—é“666å·", grade:"äº”æ˜Ÿ"}
]);
db.product.insertMany([
    {_id:1, shop_store_id:1, name:"æ°´", description:"èƒ½æœ‰æ•ˆç¼“è§£å£æ¸´", price:2.00},
    {_id:2, shop_store_id:2, name:"ç±³é¥­", description:"èƒ½æœ‰æ•ˆç¼“è§£é¥¥é¥¿", price:1.00},
    {_id:3, shop_store_id:1, name:"é¦™çƒŸ", description:"èƒ½æœ‰æ•ˆç¼“è§£å¯‚å¯", price:88.88},
    {_id:4, shop_store_id:1, name:"é…’", description:"èƒ½æœ‰æ•ˆç¼“è§£å¿§æ„", price:99.00},
    {_id:5, shop_store_id:1, name:"ç‰›å¥¶", description:"èƒ½å¸®åŠ©é•¿èº«ä½“", price:4.00},
    {_id:6, shop_store_id:2, name:"å’–å•¡", description:"èƒ½æœ‰æ•ˆç¼“è§£ç–²åŠ³", price:9.99},
    {_id:7, shop_store_id:1, name:"æ£‰è¡£", description:"èƒ½æœ‰æ•ˆç¼“è§£å¯’å†·", price:188.00},
    {_id:8, shop_store_id:2, name:"è¾£æ¡", description:"èƒ½æœ‰æ•ˆç¼“è§£å˜´é¦‹", price:5.00}
]);
```

åœ¨ä»¥å¤–ï¼Œä¸ºäº†å®ç°æ•°æ®çš„å…³è”æ€§ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†å•†åº—æ•°æ®ï¼ŒåµŒå…¥åˆ°å•†å“æ•°æ®çš„æŸä¸ªå­—æ®µä¸­ï¼Œè€Œåœ¨ç›®å‰çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œå´æ˜¯é€šè¿‡`shop_store_id`å­—æ®µæ¥å…³è”å•†å“æ‰€åœ¨çš„å•†åº—ï¼ŒæŸ¥è¯¢æ—¶åˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ


å¦‚ä¸‹ï¼š
```JavaScript
db.shop_store.aggregate([
  {
    $lookup: {
      from: "product",
      localField: "_id",
      foreignField: "shop_store_id",
      as: "products"
    }
  }
]);
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº†èšåˆç®¡é“ä¸­çš„`$lookup`æ“ä½œç¬¦ï¼Œæ¥å®ç°å¤šä¸ªé›†åˆä¹‹é—´çš„å…³è”æŸ¥è¯¢ï¼Œå…¶ä¸­ä¸»è¦æœ‰å››ä¸ªå‚æ•°ï¼š

- `from`ï¼šè¦å…³è”çš„é›†åˆåç§°ï¼Œè¿™é‡Œæ˜¯ç”¨å•†åº—å…³è”å•†å“ï¼Œæ‰€ä»¥å†™`product`ï¼›
- `localField`ï¼š`shop_store`é›†åˆä¸­ç”¨äºå…³è”çš„å­—æ®µï¼Œè¿™é‡Œæ˜¯`_id`ï¼›
- `foreignField`ï¼š`product`é›†åˆä¸­ç”¨äºå…³è”çš„å­—æ®µï¼Œè¿™é‡Œæ˜¯`shop_store_id`ï¼›
- `as`ï¼šæŒ‡å®šä¸¤ä¸ªé›†åˆåŒ¹é…çš„æ•°æ®ï¼Œè¦ä¿å­˜åˆ°çš„å­—æ®µåç§°ï¼Œè¿™é‡Œå†™äº†`products`ã€‚

ç”±äºå…³è”æŸ¥è¯¢ï¼Œä¹Ÿä¾é äºèšåˆç®¡é“æ¥å®Œæˆï¼Œä¸ºæ­¤å¤§å®¶å¯ä»¥åœ¨å…³è”æŸ¥è¯¢çš„å‰åï¼Œæ’å…¥å„ç§ä¸šåŠ¡æ‰€éœ€çš„é˜¶æ®µï¼Œä»¥æ»¡è¶³å„ç§ç‰¹æ®Šåœºæ™¯ä¸‹çš„éœ€æ±‚ï¼Œä¸è¿‡è¿™é‡Œæ³¨æ„ï¼š**å…³è”æŸ¥è¯¢ç»“æŸåï¼Œé©±åŠ¨é›†ï¼ˆè°ƒç”¨`aggregate`æ–¹æ³•çš„é›†åˆï¼‰çš„å­—æ®µä¼šå®Œæ•´è¾“å‡ºï¼Œè€Œè¢«é©±åŠ¨é›†çš„å­—æ®µï¼Œä¼šä»¥`Json`å¯¹è±¡çš„å½¢å¼ï¼Œæ”¾å…¥åˆ°æŒ‡å®šçš„å­—æ®µä¸­ï¼Œæœ€ç»ˆå½¢æˆä¸€ä¸ª`Json`æ•°ç»„ï¼Œå³æ¡ˆä¾‹ä¸­çš„`products`**ã€‚

æœ€åï¼Œå¦‚æœä½ çš„éœ€æ±‚ä¸­ï¼Œéœ€è¦å…³è”å¹¶ç­›é€‰æ•°æ®ï¼Œé‚£ä¹ˆæœ€å¥½å°†ç­›é€‰åŠ¨ä½œæ”¾åˆ°å…³è”æŸ¥è¯¢å‰é¢ï¼Œå°½å¯èƒ½çš„å‡å°å…³è”æŸ¥è¯¢æ—¶çš„æ•°æ®é›†ï¼Œå› ä¸º`$lookup`æ“ä½œç¬¦ï¼Œåº•å±‚å°±æ˜¯ä¸¤ä¸ª`for`å¾ªç¯ï¼Œå¦‚æœä¸¤ä¸ªé›†åˆéƒ½æœ‰`100W`æ¡æ•°æ®ï¼Œæœªåšç­›é€‰ç›´æ¥å…³è”æŸ¥è¯¢ï¼Œæ­¤æ—¶æ€§èƒ½å ªå¿§â€¦â€¦



# 7 $type
  
$typeæ“ä½œç¬¦æ˜¯åŸºäºBSONç±»å‹æ¥æ£€ç´¢é›†åˆä¸­åŒ¹é…çš„æ•°æ®ç±»å‹ï¼Œå¹¶è¿”å›ç»“æœã€‚


![](image/Pasted%20image%2020250226215349.png)
  

```js
> db.collectionName.insert({
    title: 'PHP æ•™ç¨‹', 
    description: 'PHP æ˜¯ä¸€ç§åˆ›å»ºåŠ¨æ€äº¤äº’æ€§ç«™ç‚¹çš„å¼ºæœ‰åŠ›çš„æœåŠ¡å™¨ç«¯è„šæœ¬è¯­è¨€ã€‚',
    by: 'UrbaneH',
    url: 'http://www.xxx.com',
    tags: ['php'],
    likes: 200
})
> db.collectionName.insert({title: 'Java æ•™ç¨‹', 
    description: 'Java æ˜¯ç”±Sun Microsystemså…¬å¸äº1995å¹´5æœˆæ¨å‡ºçš„é«˜çº§ç¨‹åºè®¾è®¡è¯­è¨€ã€‚',
    by: 'UrabaneH',
    url: 'http://www.xxx.com',
    tags: ['java'],
    likes: 150
})
> db.collectionName.insert({title: 'MongoDB æ•™ç¨‹', 
    description: 'MongoDB æ˜¯ä¸€ä¸ª Nosql æ•°æ®åº“',
    by: 'UrabaneH',
    url: 'http://www.xxx.com',
    tags: ['mongodb'],
    likes: 100
})

```

ä½¿ç”¨ $type ä¸»è¦ç”¨äºé€‰æ‹©é›†åˆä¸­æŒ‡å®šå­—æ®µæŒ‡å®šç±»å‹çš„æ•°æ®ï¼Œæ¯”æ–¹è¯´ä¸Šé¢æ˜¯é€‰å–é›†åˆä¸­ title å­—æ®µä¸­ç±»å‹ä¸º String çš„æ•°æ®ï¼›
```

db.collectionName.find({"title" : {$type : 2}})
æˆ–
db.collectionName.find({"title" : {$type : 'string'}})


ğŸ–¨ï¸è¾“å‡º:

     

{ "_id" : ObjectId("56066542ade2f21f36b0313a"), "title" : "PHP æ•™ç¨‹", "description" : "PHP æ˜¯ä¸€ç§åˆ›å»ºåŠ¨æ€äº¤äº’æ€§ç«™ç‚¹çš„å¼ºæœ‰åŠ›çš„æœåŠ¡å™¨ç«¯è„šæœ¬è¯­è¨€ã€‚", "by" : "UrbaneH", "url" : "http://www.xxx.com", "tags" : [ "php" ], "likes" : 200 }
{ "_id" : ObjectId("56066549ade2f21f36b0313b"), "title" : "Java æ•™ç¨‹", "description" : "Java æ˜¯ç”±Sun Microsystemså…¬å¸äº1995å¹´5æœˆæ¨å‡ºçš„é«˜çº§ç¨‹åºè®¾è®¡è¯­è¨€ã€‚", "by" : "UrbaneH", "url" : "http://www.xxx.com", "tags" : [ "java" ], "likes" : 150 }
{ "_id" : ObjectId("5606654fade2f21f36b0313c"), "title" : "MongoDB æ•™ç¨‹", "description" : "MongoDB æ˜¯ä¸€ä¸ª Nosql æ•°æ®åº“", "by" : "UrbaneH", "url" : "http://www.xxx.com", "tags" : [ "mongodb" ], "likes" : 100 }

```